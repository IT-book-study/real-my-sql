# 10.1 통계 정보 
## 10.1.1 테이블 및 인덱스 통계 정보 
- 비용 기반 최적화에서 가장 중요한 것은 통계 정보 

### 10.1.1.1 MySQL 서버의 통계 정보 
- InnoDB 스토리지 엔진을 사용하는 테이블에 대한 통계 정보를 영구적으로 관리할 수 있도록 테이블의 형태로 저장함 
  - 의도하지 않은 통계 정보 변경을 막을 수 있음 
  - 통계 정보 자동 갱신 (`innodb_stats_auto_recalc`)을 `OFF`로 변경하면 자동 갱신을 막을 수 있음 → 영구적인 통계 정보를 이용하고자 할 때 사용 
- 정확한 통계 정보를 수집하는 것이 쿼리 성능에 도움이될 수 있음
  - 서버 점검, 사용량이 많지 않은 시간을 이용해 정확한 정보를 수집 


## 10.1.2 히스토그램 
- 컬럼의 데이터 분포도를 참조할 수 있는 정보 

### 10.1.2.1 히스토그램 정보 수집 및 삭제 
- 히스토그램 정보는 컬럼 단위로 관리됨 
- `ANALYZE TABLE` 명령을 통해 수동으로 수집 및 관리 
  - 시스템 딕셔너리에 함께 저장 
  - MySQL 서버가 시작될 때 딕셔너리의 히스토그램 정보를 `information_schema` 스키마의 `column_statistics` 테이블에 로딩
- 히스토그램은 Bucket 단위로 구분되어 관리됨
- 2 종류의 히스토그램 타입
  - ![img.png](img.png)
  - `Singleton`
    - 컬럼 값 개별로 레코드 건수 관리 
      - 컬럼 값 별로 버킷 할당 
      - 버킷 구성: 컬럼 값 + 발생 빈도 비율 
    - 누적 값이 표현됨 
      - 그림 상에서 `M` = 0.5998 , `F` = 1 - 0.5998
    - value-based 히스토그램 or 도수 분포도 
  - `Equi-Height`
    - 컬럼 값의 범위를 균등한 개수로 구분해서 관리
      - 개수가 균등한 컬럼값의 범위 별로 하나의 버킷 할당
      - 버킷 구성: 범위 시작 값 + 마지막 값 + 발생 빈도 비율 + 버킷에 포함된 유니크한 값의 개수
    - 컬럼 값의 각 범위에 대해 레코드 건수 비율이 누적으로 표시됨 
      - 그림 상에서 기울기가 일정한것을 보면 각 범위가 비슷한 값의 레코드 건수를 가진다는 것을 알 수 있음 
    - Height-Balanced 히스토그램 


### 10.1.2.2 히스토그램의 용도 
- 실제 응용 프로그램 데이터는 항상 균등한 분포도를 가지지 않음 
- 히스토그램을 이용해 데이터 분포도를 파악하고, 이를 이용해 쿼리 실행 계획을 수립할 수 있음
  - 버킷 별 레코드 건수, 유니크한 값의 개수 정보 등을 가지기 때문에 더 정확한 예측이 가능 
- 히스토그램 정보가 없으면, 옵티마이저는 데이터가 균등하게 분포돼 있을 것으로 예측함
- 히스토그램이 있으면, 특정 범위의 데이터가 많고 적음을 식별할 수 있음 
  - 어느 테이블을 먼저 읽어야 조인의 횟수를 줄일 수 있을지 더 정확히 판단 가능 


### 10.1.2.3 히스토그램과 인덱스 
- 인덱스 다이브
  - 사용 가능한 인덱스들로 부터 조건절에 일치하는 레코드 건수를 대략 파악하기 위해 실제 인덱스의 B-Tree를 샘플링해서 살펴보는 것 
- 인덱스된 컬럼에 대해 히스토그램 정보를 수집 해두는 것이 좋을까?
  - 인덱스된 컬럼을 검색 조건으로 사용하는 경우, 해당 컬럼의 히스토그램은 사용하지 않고 실제 인덱스 다이브를 통해 수집한 정보를 활용함 
  - 이는 실제 검색 조건의 대상 값에 대한 샘플링을 실행하는 것 → 항상 히스토그램보다 정확한 결과를 기대할 수 있음 
  - 따라서, 히스토그램은 주로 **인덱스되지 않은 컬럼에 대한 데이터 분포도를 참조하는 용도**로 사용함 
- 인덱스 다이브는 어느 정도의 비용이 필요함 
  - `IN` 절에 값이 많이 명시된 경우, 실행 계획 수립만으로도 상당한 인덱스 다이브를 실행함 (비용 증가)



 